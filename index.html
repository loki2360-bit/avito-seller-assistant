<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Avito Seller Assistant</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#e74c3c" />
</head>
<body>
  <div class="container">
    <h1>üõ†Ô∏è Avito Seller Assistant</h1>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ -->
    <section class="form-section">
      <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞</h2>
      <form id="competitorForm">
        <select id="category" required>
          <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø ‚Äî</option>
          <option value="–ø—Ä–æ–¥–∞–∂–∞">–ü—Ä–æ–¥–∞–∂–∞ —Ç–µ—Ö–Ω–∏–∫–∏</option>
          <option value="—Ä–µ–º–æ–Ω—Ç">–†–µ–º–æ–Ω—Ç</option>
        </select>
        <input type="text" id="deviceType" placeholder="–¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: iPhone 13)" required />
        <input type="url" id="avitoUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ Avito (–æ–ø—Ü.)" />
        <input type="text" id="title" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ" required />
        <input type="number" id="price" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)" required min="0" />
        <input type="text" id="city" placeholder="–ì–æ—Ä–æ–¥ –∏–ª–∏ —Ä–∞–π–æ–Ω" />
        <textarea id="notes" placeholder="–ó–∞–º–µ—Ç–∫–∏: –æ—Ç–∑—ã–≤—ã, –≥–∞—Ä–∞–Ω—Ç–∏—è, —Å–∫–æ—Ä–æ—Å—Ç—å..."></textarea>
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </form>
    </section>

    <!-- –®–∞–±–ª–æ–Ω—ã -->
    <section class="templates-section">
      <h2>üìù –ú–æ–∏ —à–∞–±–ª–æ–Ω—ã –æ–ø–∏—Å–∞–Ω–∏–π</h2>
      <div id="templatesList"></div>
      <form id="templateForm" style="margin-top: 12px;">
        <input type="text" id="templateTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: iPhone —ç–∫—Ä–∞–Ω)" required />
        <textarea id="templateText" placeholder="–¢–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è..." required></textarea>
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
      </form>
    </section>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ -->
    <section class="list-section" id="mainSection">
      <div class="controls">
        <h2>üìã –ú–æ–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã (<span id="count">0</span>)</h2>
        <div>
          <button id="exportBtn">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
          <button id="copyTableBtn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
          <button id="clearBtn" style="margin-left: 10px; background: #e74c3c;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>
      <div id="competitorsList"></div>
    </section>

    <!-- –í–∫–ª–∞–¥–∫–∞ –ø—Ä–µ–¥–∑–∞–∫–∞–∑–æ–≤ -->
    <section class="list-section" id="preordersSection" style="display: none;">
      <div class="controls">
        <h2>üìã –ü—Ä–µ–¥–∑–∞–∫–∞–∑—ã (<span id="preordersCount">0</span>)</h2>
        <div>
          <!-- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –ò–ú–ü–û–†–¢–ê -->
          <button id="importJsonBtn">üì§ –ò–º–ø–æ—Ä—Ç JSON</button>
          <button id="exportPreordersBtn">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
          <button id="clearPreordersBtn" style="margin-left: 10px; background: #e74c3c;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>
      <div id="preordersList"></div>
    </section>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –≤–∫–ª–∞–¥–æ–∫ -->
    <div style="text-align: center; margin-top: 20px;">
      <button id="mainTabBtn" class="tab-btn active">–û—Å–Ω–æ–≤–Ω—ã–µ</button>
      <button id="preordersTabBtn" class="tab-btn">–ü—Ä–µ–¥–∑–∞–∫–∞–∑—ã</button>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–π —Ñ–∞–π–ª–æ–≤—ã–π –≤–≤–æ–¥ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ -->
    <input type="file" id="jsonFileInput" accept=".json" style="display: none;" />

  </div>

  <script>
    // === –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö ===
    let competitors = JSON.parse(localStorage.getItem('competitors')) || [];
    let templates = JSON.parse(localStorage.getItem('templates')) || [];
    let preorders = JSON.parse(localStorage.getItem('preorders')) || [];

    // === DOM —ç–ª–µ–º–µ–Ω—Ç—ã ===
    const competitorForm = document.getElementById('competitorForm');
    const templateForm = document.getElementById('templateForm');
    const competitorsList = document.getElementById('competitorsList');
    const templatesList = document.getElementById('templatesList');
    const countElement = document.getElementById('count');
    const preordersList = document.getElementById('preordersList');
    const preordersCount = document.getElementById('preordersCount');

    // –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
    const mainTabBtn = document.getElementById('mainTabBtn');
    const preordersTabBtn = document.getElementById('preordersTabBtn');
    const mainSection = document.getElementById('mainSection');
    const preordersSection = document.getElementById('preordersSection');

    // –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞/–æ—á–∏—Å—Ç–∫–∏
    const exportBtn = document.getElementById('exportBtn');
    const copyTableBtn = document.getElementById('copyTableBtn');
    const clearBtn = document.getElementById('clearBtn');
    const exportPreordersBtn = document.getElementById('exportPreordersBtn');
    const clearPreordersBtn = document.getElementById('clearPreordersBtn');

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
    document.addEventListener('DOMContentLoaded', () => {
      renderCompetitors();
      renderTemplates();
      renderPreorders();
      updateCount();
      updatePreordersCount();
    });

    // === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ ===
    mainTabBtn.addEventListener('click', () => {
      mainSection.style.display = 'block';
      preordersSection.style.display = 'none';
      mainTabBtn.classList.add('active');
      preordersTabBtn.classList.remove('active');
    });

    preordersTabBtn.addEventListener('click', () => {
      mainSection.style.display = 'none';
      preordersSection.style.display = 'block';
      preordersTabBtn.classList.add('active');
      mainTabBtn.classList.remove('active');
      renderPreorders();
    });

    // === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ ===
    competitorForm?.addEventListener('submit', (e) => {
      e.preventDefault();
      const competitor = {
        id: Date.now(),
        category: document.getElementById('category').value,
        deviceType: document.getElementById('deviceType').value,
        avitoUrl: document.getElementById('avitoUrl').value,
        title: document.getElementById('title').value,
        price: parseFloat(document.getElementById('price').value),
        city: document.getElementById('city').value,
        notes: document.getElementById('notes').value,
        date: new Date().toISOString()
      };
      competitors.push(competitor);
      saveCompetitors();
      renderCompetitors();
      updateCount();
      competitorForm.reset();
    });

    // === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ ===
    templateForm?.addEventListener('submit', (e) => {
      e.preventDefault();
      const template = {
        id: Date.now(),
        title: document.getElementById('templateTitle').value,
        text: document.getElementById('templateText').value,
        date: new Date().toISOString()
      };
      templates.push(template);
      saveTemplates();
      renderTemplates();
      templateForm.reset();
    });

    // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage ===
    function saveCompetitors() {
      localStorage.setItem('competitors', JSON.stringify(competitors));
    }
    function saveTemplates() {
      localStorage.setItem('templates', JSON.stringify(templates));
    }
    function savePreorders() {
      localStorage.setItem('preorders', JSON.stringify(preorders));
    }

    // === –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–æ–≤ ===
    function renderCompetitors() {
      if (!competitorsList) return;
      if (competitors.length === 0) {
        competitorsList.innerHTML = '<p class="empty-message">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</p>';
        return;
      }
      const sorted = [...competitors].sort((a, b) => new Date(b.date) - new Date(a.date));
      competitorsList.innerHTML = sorted.map(c => `
        <div class="item">
          <strong>${c.deviceType}</strong> ‚Äî ${c.title}<br>
          <small>${c.category} ‚Ä¢ ${c.city || '‚Äî'} ‚Ä¢ ${c.price.toLocaleString()} ‚ÇΩ</small><br>
          ${c.notes ? `<em>üìù ${c.notes}</em><br>` : ''}
          ${c.avitoUrl ? `<a href="${c.avitoUrl}" target="_blank">üîó Avito</a>` : ''}
          <button onclick="deleteCompetitor(${c.id})" style="float:right; margin-top:5px;">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    function renderTemplates() {
      if (!templatesList) return;
      if (templates.length === 0) {
        templatesList.innerHTML = '<p class="empty-message">–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤</p>';
        return;
      }
      templatesList.innerHTML = templates.map(t => `
        <div class="item">
          <strong>${t.title}</strong><br>
          <pre style="white-space: pre-wrap; font-size: 0.9em;">${t.text}</pre>
          <button onclick="deleteTemplate(${t.id})" style="float:right;">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    function renderPreorders() {
      if (!preordersList) return;
      if (preorders.length === 0) {
        preordersList.innerHTML = '<p class="empty-message">–ù–µ—Ç –ø—Ä–µ–¥–∑–∞–∫–∞–∑–æ–≤</p>';
        return;
      }
      const sorted = [...preorders].sort((a, b) => new Date(b.date) - new Date(a.date));
      preordersList.innerHTML = sorted.map(p => `
        <div class="item">
          <strong>${p.deviceType || p.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong><br>
          <small>${p.price ? `${p.price.toLocaleString()} ‚ÇΩ` : ''}${p.city ? ` ‚Ä¢ ${p.city}` : ''}</small><br>
          ${p.notes ? `<em>üìù ${p.notes}</em><br>` : ''}
          <button onclick="moveToMain(${p.id})" style="margin-right: 5px;">‚û°Ô∏è –í –æ—Å–Ω–æ–≤–Ω—ã–µ</button>
          <button onclick="deletePreorder(${p.id})" style="float:right;">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ ===
    function updateCount() {
      countElement.textContent = competitors.length;
    }
    function updatePreordersCount() {
      preordersCount.textContent = preorders.length;
    }

    // === –£–¥–∞–ª–µ–Ω–∏–µ ===
    window.deleteCompetitor = (id) => {
      competitors = competitors.filter(c => c.id !== id);
      saveCompetitors();
      renderCompetitors();
      updateCount();
    };
    window.deleteTemplate = (id) => {
      templates = templates.filter(t => t.id !== id);
      saveTemplates();
      renderTemplates();
    };
    window.deletePreorder = (id) => {
      preorders = preorders.filter(p => p.id !== id);
      savePreorders();
      renderPreorders();
      updatePreordersCount();
    };

    // === –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ ===
    window.moveToMain = (id) => {
      const order = preorders.find(p => p.id === id);
      if (order) {
        competitors.push(order);
        preorders = preorders.filter(p => p.id !== id);
        saveCompetitors();
        savePreorders();
        renderCompetitors();
        renderPreorders();
        updateCount();
        updatePreordersCount();
      }
    };

    // === –≠–∫—Å–ø–æ—Ä—Ç (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π) ===
    exportBtn?.addEventListener('click', () => {
      const csv = ['–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ,–û–ø–∏—Å–∞–Ω–∏–µ,–¶–µ–Ω–∞,–ì–æ—Ä–æ–¥,–¢–∏–ø,–°—Å—ã–ª–∫–∞,–ó–∞–º–µ—Ç–∫–∏'];
      competitors.forEach(c => {
        csv.push([
          `"${c.deviceType}"`,
          `"${c.title}"`,
          c.price,
          `"${c.city || ''}"`,
          `"${c.category}"`,
          `"${c.avitoUrl || ''}"`,
          `"${c.notes || ''}"`
        ].join(','));
      });
      downloadFile('competitors.csv', csv.join('\n'), 'text/csv');
    });

    exportPreordersBtn?.addEventListener('click', () => {
      const csv = ['–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ,–û–ø–∏—Å–∞–Ω–∏–µ,–¶–µ–Ω–∞,–ì–æ—Ä–æ–¥,–ó–∞–º–µ—Ç–∫–∏'];
      preorders.forEach(p => {
        csv.push([
          `"${p.deviceType || ''}"`,
          `"${p.title || ''}"`,
          p.price || '',
          `"${p.city || ''}"`,
          `"${p.notes || ''}"`
        ].join(','));
      });
      downloadFile('preorders.csv', csv.join('\n'), 'text/csv');
    });

    // === –û—á–∏—Å—Ç–∫–∞ ===
    clearBtn?.addEventListener('click', () => {
      if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏?')) {
        competitors = [];
        saveCompetitors();
        renderCompetitors();
        updateCount();
      }
    });

    clearPreordersBtn?.addEventListener('click', () => {
      if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–µ–¥–∑–∞–∫–∞–∑—ã?')) {
        preorders = [];
        savePreorders();
        renderPreorders();
        updatePreordersCount();
      }
    });

    // === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
    function downloadFile(filename, content, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ==============================
    // === –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ò–ú–ü–û–†–¢ JSON –í –ü–†–ï–î–ó–ê–ö–ê–ó–´ ===
    // ==============================

    const importJsonBtn = document.getElementById('importJsonBtn');
    const jsonFileInput = document.getElementById('jsonFileInput');

    importJsonBtn?.addEventListener('click', () => {
      jsonFileInput.click();
    });

    jsonFileInput?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const importedOrders = JSON.parse(event.target.result);

          if (!Array.isArray(importedOrders)) {
            alert('–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∞—Å—Å–∏–≤ –∑–∞–∫–∞–∑–æ–≤!');
            return;
          }

          // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ø—Ä–µ–¥–∑–∞–∫–∞–∑—ã
          preorders = [...preorders, ...importedOrders];
          savePreorders();
          renderPreorders();
          updatePreordersCount();

          alert(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${importedOrders.length} –∑–∞–∫–∞–∑–æ–≤!`);
        } catch (err) {
          console.error(err);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ JSON-—Ñ–∞–π–ª–∞:\n' + err.message);
        }
      };
      reader.readAsText(file);
    });

  </script>

  <style>
    /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç –≤ style.css */
    .tab-btn {
      padding: 8px 16px;
      margin: 0 5px;
      border: none;
      background: #f1f1f1;
      cursor: pointer;
      border-radius: 4px;
    }
    .tab-btn.active {
      background: #e74c3c;
      color: white;
    }
    .empty-message {
      color: #888;
      font-style: italic;
    }
  </style>
</body>
</html>
