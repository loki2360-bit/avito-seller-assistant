<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–¥–º–∏–Ω–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
    body {
      padding: 20px;
      background: #f5f7fa;
      color: #222;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h2 { margin: 20px 0 12px; }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background: #2196F3;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    button.copy-btn {
      background: #4CAF50;
      width: auto;
      padding: 6px 12px;
      font-size: 14px;
      margin-left: 8px;
    }
    #qr-display img {
      display: block;
      margin: 20px auto;
      max-width: 250px;
      border: 1px solid #eee;
      border-radius: 12px;
      background: white;
      padding: 8px;
    }
    .section { background: white; padding: 16px; border-radius: 12px; margin-top: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .hidden { display: none !important; }
    .info { background: #e3f2fd; padding: 12px; border-radius: 8px; margin: 12px 0; }
    .error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 6px; margin: 10px 0; }
    .success { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; margin: 10px 0; }
    .history-item { padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéüÔ∏è –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</h1>

    <!-- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ù–û–í–û–ì–û –ö–õ–ò–ï–ù–¢–ê -->
    <div class="section">
      <h2>‚ûï –í—ã–¥–∞—Ç—å –Ω–æ–≤—ã–π QR</h2>
      <button onclick="generateNewUser()">–°–æ–∑–¥–∞—Ç—å QR –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞</button>
      <div id="new-qr-display" class="hidden">
        <h3>–ù–æ–≤—ã–π QR:</h3>
        <div id="new-qr-img"></div>
        <p><strong>–°—Ç—Ä–æ–∫–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:</strong></p>
        <input id="new-qr-text" readonly />
        <button class="copy-btn" onclick="copyToClipboard('new-qr-text')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <p><em>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–ª–∏–µ–Ω—Ç—É –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ —Å—Ç—Ä–æ–∫—É.</em></p>
      </div>
    </div>

    <!-- –û–ë–†–ê–ë–û–¢–ö–ê –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û QR -->
    <div class="section">
      <h2>üîÑ –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–ª—ã –ø–æ QR</h2>
      <p>–í—Å—Ç–∞–≤—å—Ç–µ –≤—Å—é —Å—Ç—Ä–æ–∫—É –∏–∑ QR-–∫–æ–¥–∞ (–∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID –∏ –±–∞–ª–ª—ã):</p>
      
      <input type="text" id="input-qr-full" placeholder="id:abc|points:100|hash:XYZ..." />
      <div id="qr-error" class="error hidden"></div>
      <div id="qr-valid" class="success hidden">‚úÖ QR –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω</div>

      <h3>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤</h3>
      <input type="number" id="change-points" placeholder="¬± –±–∞–ª–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: 50 –∏–ª–∏ -30)" />
      
      <button onclick="processUpdate()">–û–±–Ω–æ–≤–∏—Ç—å –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π QR</button>

      <div id="result-qr-display" class="hidden">
        <h3>–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π QR:</h3>
        <div id="result-qr-img"></div>
        <p><strong>–°—Ç—Ä–æ–∫–∞:</strong></p>
        <input id="result-qr-text" readonly />
        <button class="copy-btn" onclick="copyToClipboard('result-qr-text')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <p class="info">‚úÖ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç QR –∫–ª–∏–µ–Ω—Ç—É.</p>
      </div>
    </div>

    <!-- –ò–°–¢–û–†–ò–Ø –ò –≠–ö–°–ü–û–†–¢ -->
    <div class="section">
      <h2>üíæ –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
      <button onclick="exportHistory('txt')">–≠–∫—Å–ø–æ—Ä—Ç –≤ TXT</button>
      <button onclick="exportHistory('json')">–≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
      <div id="history-list" style="margin-top:12px; max-height:200px; overflow:auto;"></div>
    </div>

    <!-- –ò–ù–°–¢–†–£–ö–¶–ò–Ø -->
    <div class="section" style="margin-top: 30px; font-size: 14px; color: #666;">
      <h3>‚ÑπÔ∏è –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</h3>
      <ul>
        <li>–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç ‚Üí ¬´–°–æ–∑–¥–∞—Ç—å QR¬ª ‚Üí –ø–æ–ª—É—á–∏—Ç–µ QR —Å 100 –±–∞–ª–ª–∞–º–∏.</li>
        <li>–ö–ª–∏–µ–Ω—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç QR ‚Üí –≤—ã –≤—Å—Ç–∞–≤–ª—è–µ—Ç–µ –í–°–Æ —Å—Ç—Ä–æ–∫—É –≤ –ø–æ–ª–µ –≤—ã—à–µ.</li>
        <li>–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å ‚Üí –≤–≤–µ–¥–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤.</li>
        <li>–ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–π QR ‚Üí –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–ª–∏–µ–Ω—Ç—É.</li>
      </ul>
    </div>
  </div>

  <!-- QR Generator -->
  <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
  <script>
    // === –°–ï–ö–†–ï–¢ –î–õ–Ø –ü–û–î–ü–ò–°–ò ===
    const SECRET = "loyalty-secret-2026"; // ‚Üê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò–¢–ï!

    // –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
    let history = JSON.parse(localStorage.getItem('loyalty_history') || '[]');

    // –•—ç—à
    function makeHash(id, points) {
      const str = `${id}|${points}|${SECRET}`;
      return btoa(str).replace(/[^a-zA-Z0-9]/g, '').substring(0, 12).toUpperCase();
    }

    function verifyData(id, points, hash) {
      return makeHash(id, points) === hash;
    }

    function encodeToQRString(id, points) {
      const hash = makeHash(id, points);
      return `id:${id}|points:${points}|hash:${hash}`;
    }

    function parseQRString(str) {
      const parts = str.split('|');
      const data = {};
      parts.forEach(part => {
        const [key, val] = part.split(':');
        if (key && val) data[key] = key === 'points' ? parseInt(val) : val;
      });
      return data;
    }

    function generateQRImage(dataStr) {
      const qr = qrcode(0, 'M');
      qr.addData(dataStr);
      qr.make();
      return qr.createImgTag(6);
    }

    function addToHistory(action, id, oldPoints, newPoints) {
      const entry = {
        time: new Date().toISOString(),
        action,
        id,
        oldPoints,
        newPoints
      };
      history.unshift(entry);
      if (history.length > 200) history = history.slice(0, 200); // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
      localStorage.setItem('loyalty_history', JSON.stringify(history));
      renderHistory();
    }

    function renderHistory() {
      const list = document.getElementById('history-list');
      list.innerHTML = history.map(item => `
        <div class="history-item">
          ${new Date(item.time).toLocaleString()} ‚Äî ${item.action} 
          ID: ${item.id} (${item.oldPoints} ‚Üí ${item.newPoints})
        </div>
      `).join('');
    }

    // === –ö–û–ü–ò–†–û–í–ê–ù–ò–ï ===
    function copyToClipboard(id) {
      const el = document.getElementById(id);
      el.select();
      document.execCommand('copy');
      alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
    }

    // === –ù–û–í–´–ô –ö–õ–ò–ï–ù–¢ ===
    function generateNewUser() {
      const id = Math.random().toString(36).substring(2, 10) + Date.now().toString(36).slice(-4);
      const points = 100;
      const qrStr = encodeToQRString(id, points);
      const imgTag = generateQRImage(qrStr);

      document.getElementById('new-qr-img').innerHTML = imgTag;
      document.getElementById('new-qr-text').value = qrStr;
      document.getElementById('new-qr-display').classList.remove('hidden');

      addToHistory("–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç", id, 0, points);
    }

    // === –û–ë–ù–û–í–õ–ï–ù–ò–ï ===
    function processUpdate() {
      const fullStr = document.getElementById('input-qr-full').value.trim();
      if (!fullStr) {
        alert("–í—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É –∏–∑ QR-–∫–æ–¥–∞");
        return;
      }

      const data = parseQRString(fullStr);
      if (!data.id || isNaN(data.points) || !data.hash) {
        document.getElementById('qr-error').innerText = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR";
        document.getElementById('qr-error').classList.remove('hidden');
        document.getElementById('qr-valid').classList.add('hidden');
        return;
      }

      if (!verifyData(data.id, data.points, data.hash)) {
        document.getElementById('qr-error').innerText = "‚ùå –ü–æ–¥–¥–µ–ª—å–Ω—ã–π QR! –•—ç—à –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç.";
        document.getElementById('qr-error').classList.remove('hidden');
        document.getElementById('qr-valid').classList.add('hidden');
        return;
      }

      document.getElementById('qr-error').classList.add('hidden');
      document.getElementById('qr-valid').classList.remove('hidden');

      const change = parseInt(document.getElementById('change-points').value);
      if (isNaN(change)) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤");
        return;
      }

      let newPoints = data.points + change;
      if (newPoints < 0) newPoints = 0;

      const newQrStr = encodeToQRString(data.id, newPoints);
      const imgTag = generateQRImage(newQrStr);

      document.getElementById('result-qr-img').innerHTML = imgTag;
      document.getElementById('result-qr-text').value = newQrStr;
      document.getElementById('result-qr-display').classList.remove('hidden');

      addToHistory("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ", data.id, data.points, newPoints);
    }

    // === –≠–ö–°–ü–û–†–¢ –ò–°–¢–û–†–ò–ò ===
    function exportHistory(format) {
      let dataStr, filename;
      if (format === 'txt') {
        let txt = "–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏\n===========================\n\n";
        history.forEach(item => {
          txt += `${new Date(item.time).toLocaleString()} | ${item.action} | ID: ${item.id} | ${item.oldPoints} ‚Üí ${item.newPoints}\n`;
        });
        dataStr = "text/plain;charset=utf-8," + encodeURIComponent(txt);
        filename = `loyalty_history_${new Date().toISOString().slice(0,10)}.txt`;
      } else {
        dataStr = "application/json;charset=utf-8," + encodeURIComponent(JSON.stringify(history, null, 2));
        filename = `loyalty_history_${new Date().toISOString().slice(0,10)}.json`;
      }

      const link = document.createElement("a");
      link.setAttribute("href", dataStr);
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    window.onload = () => {
      renderHistory();
    };
  </script>
</body>
</html>
